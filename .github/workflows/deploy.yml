name: Deploy MkDocs site to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: dhis2-chap/chap-site
          ref: doc-reorganizing

      - name: Create pyproject.toml
        run: |
          cat > pyproject.toml << 'EOF'
          [project]
          name = "chap-site-reorganized"
          version = "0.1.0"
          description = "DHIS2 Modeling documentation site"
          requires-python = ">=3.10"
          dependencies = [
              "mkdocs",
              "mkdocs-material",
              "mkdocs-video",
              "mkdocs-gen-files",
              "mkdocs-minify-plugin",
              "pymdown-extensions",
          ]

          [project.scripts]
          serve = "mkdocs:serve"

          [tool.uv.scripts]
          serve = "mkdocs serve"
          build = "mkdocs build"
          EOF
          sed -i 's/^          //' pyproject.toml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch external documentation
        run: python scripts/fetch-external-docs.py

      - name: Deploy
        run: mkdocs gh-deploy --force
